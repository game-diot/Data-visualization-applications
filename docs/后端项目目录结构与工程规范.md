# Node.js 后端项目目录结构与工程规范

> 本文档用于**约束和说明本项目 Node.js 后端的目录结构、职责边界与工程规则**。
> 目标是：**结构清晰、职责单一、便于扩展、可长期演进**。

---

## 一、设计总原则（必须遵守）

### 1. 单一职责原则（SRP）
- 一个目录 / 文件 **只做一类事情**
- 不允许“顺手多做一点”

### 2. 明确边界原则
- **Node.js 负责流程调度 + 状态管理 + 数据落库**
- **FastAPI 只负责计算，不拥有长期状态**
- Node.js 是唯一的 **Orchestrator（流程统筹者）**

### 3. 模块隔离原则
- `features` 之间 **禁止互相直接依赖**
- 公共能力必须上移到 `shared`

---

## 二、项目根目录说明

```text
nodejs/
├── docs/
├── logs/
├── scripts/
├── src/
├── temp/
├── uploads/
├── tests/
├── .env.*
├── Dockerfile
├── docker-compose.yml
└── README.md
```

### docs/
- 项目文档统一存放处
- 包含：
  - API 文档
  - 数据库设计文档
  - 架构说明（ARCHITECTURE.md）

### logs/
- 日志输出目录
- 按级别拆分：
  - info.log
  - warn.log
  - error.log

> ⚠️ 日志只能通过 logger 工具写入，禁止 `console.log`

### scripts/
- 运维 / 开发脚本
- 示例：
  - 初始化数据库
  - 清理临时文件
  - 本地启动脚本

---

## 三、src 核心目录结构

```text
src/
├── api/clients/
├── app/
├── features/
├── shared/
├── infrastructure/cache/
└── main.ts
```

---

## 四、api/clients —— 外部服务调用层

```text
src/api/clients/
```

### 职责
- 统一封装 **外部服务调用**：
  - FastAPI
  - AI / LangChain
  - 第三方 API

### 规则（非常重要）
- ❌ Controller 不能直接调用 axios
- ❌ Service 不能自行 new HTTP client
- ✅ 只能通过 clients 层访问外部服务

> 目的：防止外部依赖污染业务逻辑

---

## 五、app —— 应用核心层

```text
src/app/
├── config/
├── core/
├── middleware/
├── routes/
└── main.ts
```

### config/
- 所有配置加载入口
- 包含：
  - 环境变量
  - 数据库配置
  - Redis 配置

### core/
- 应用初始化逻辑
- 示例：
  - 数据库连接
  - Redis 连接
  - 全局依赖初始化

### middleware/
- 全局中间件
- 示例：
  - CORS
  - 错误处理
  - 日志记录

### routes/
- 全局路由聚合入口
- 只做一件事：**挂载各 feature 路由**

### main.ts
- 程序启动入口
- 不写业务逻辑

---

## 六、features —— 业务模块层（核心）

```text
src/features/
├── file/
│   ├── controllers/
│   ├── services/
│   ├── repository/
│   ├── models/
│   ├── routes/
│   ├── dto/
│   ├── schemas/
│   └── utils/
```

### 1️⃣ controllers/
- HTTP 层
- 只做：
  - 参数解析
  - 调用 service
  - 返回响应

❌ 禁止：
- 写业务逻辑
- 访问数据库

---

### 2️⃣ services/
- 核心业务逻辑层
- 负责：
  - 状态流转
  - 流程编排
  - 调用 repository / clients

---

### 3️⃣ repository/
- 数据访问层
- 只做：
  - CRUD
  - 查询拼装

❌ 禁止：
- 状态判断
- 调用外部 API

---

### 4️⃣ models/
- 数据库 Schema / Entity 定义
- ❌ 不写业务逻辑
- ❌ 不写查询

---

### 5️⃣ routes/
- 模块私有路由
- 最终由 `app/routes` 聚合

---

### 6️⃣ dto/
- 数据传输对象
- 用于：
  - 输入格式化
  - 输出裁剪

---

### 7️⃣ schemas/
- HTTP / DTO 数据校验
- **模块私有**

> 禁止跨模块直接引用

---

### 8️⃣ utils/
- 模块私有工具函数
- 不可被其他模块直接引用

---

## 七、shared —— 全局共享层

```text
src/shared/
├── constants/
├── exceptions/
├── utils/
└── schemas/
```

### constants/
- 枚举
- 错误码
- 状态常量

### exceptions/
- 自定义错误类
- 全项目统一使用

### utils/
- 通用工具函数

### schemas/
- **跨模块共享结构**
- 示例：
  - 文件状态枚举
  - 核心实体结构

---

## 八、infrastructure/cache —— 缓存基础设施层

```text
src/infrastructure/cache/
```

### 职责
- Redis client
- Cache key 规范
- Cache helper

### 规则
- ❌ 业务代码禁止自行拼 Redis key
- ❌ 禁止直接操作 Redis client

---

## 九、文件存储目录说明

### temp/
- 临时文件
- FastAPI / Node 中转使用
- **随时可删**

### uploads/
- 已登记的用户数据
- 与 MongoDB 强关联
- 不可随意清理

---

## 十、核心工程纪律总结

- FastAPI 不写数据库
- Node.js 是唯一状态管理者
- Feature 不可互相依赖
- 新模块必须明确：
  > 所处数据生命周期阶段

---

> 本文档是**强约束规范**，不是建议文档。
> 后续新增模块，必须遵守本规范。

